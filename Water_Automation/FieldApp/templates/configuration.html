<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Configuration - Proyect Sobek</title>
    {% include 'includeScripts.html' %}

</head>
<body>

{% include 'nav.html' %}
<div class="row">
    <div class="medium-12 columns">
        <h1>Configuration</h1>
    </div>
</div>
<div class="row card">
    <div class="medium-6 columns">
        <h3>Select the area to configure</h3>

        <label>Field</label>
        <select id="field" onchange="getAreasOptions('area', 'field')"></select>
        <label>Area</label>
        <select id="area" onchange="hideOperations();"></select>

        <button onclick="getConfigurations()">Get Configuration</button>

        <section id="opModeSelect">
            <label>Operation Mode</label>
            <select id="operationMode" onchange="loadOperationMode();">
                <option value="1">Manual</option>
                <option value="2">Automatic</option>
                <option value="3">Timer</option>
            </select>
        </section>

        <section id="opManual" class="operationModes">
            <input type="radio" name="rOpMan" id="rOpManON" value="1" selected/><label for="rOpManON">ON</label>
            <input type="radio" name="rOpMan" id="rOpManOFF" value="0"/><label for="rOpManOFF">OFF</label>
            <br/>
            <button onclick="saveOpMan();">Save</button>

        </section>

        <section id="opAutomatic" class="operationModes">
            <label for="minHum">Minimum Soil Moisture</label>
            <input type="number" id="maxHum" max="99.9" min="0" step="0.1" class="inpHumidity" value="0"/>
            <label for="maxHum">Maximum Soil Moisture</label>
            <input type="number" id="minHum" max="99.9" min="0" step="0.1" class="inpHumidity" value="0"/>

            <button onclick="saveOpAut();">Save</button>

        </section>

        <section id="opTimer" class="operationModes">
            <label>Timer Mode</label>
            <label for = "dayofweek">Select days of the week: </label>
                <br>
                <input type="checkbox" class ="dayofweek" value="128" id="mon">Mon
                <input type="checkbox" class ="dayofweek" value="64" id="tue">Tue
                <input type="checkbox" class ="dayofweek" value="32" id="wed">Wed
                <input type="checkbox" class ="dayofweek" value="16" id="thu">Thu
                <input type="checkbox" class ="dayofweek" value="8" id="fri">Fri
                <input type="checkbox" class ="dayofweek" value="4" id="sat">Sat
                <input type="checkbox" class ="dayofweek" value="2" id="sun">Sun
            <br>
            <label class ="timers">Starting at:</label>
                <input type="time" class="time" id = "start_time">
            <label class ="timers" >Duration:</label>
                <input type="time" class="time" id = "duration_time">

            <button onclick="saveOpTim();">Save</button>

        </section>

        <style>
            #opModeSelect, .operationModes {
                display: none;
            }
            input.dayofweek {
                display: inline-block;
                padding-right: 15px;
                margin-left: 15px;

            }
            input.time {
                max-width: 100px;
                float: left;
                margin-right: 25px;
            }
            label.timers{
                max-width: 200px;
                float: left;
                margin-right: 10px;
            }

            .inpHumidity {
                width: 50px;
            }
        </style>
    </div>
</div>

<script>
var strConfig;
var field_selector = $('#field');
var area_selector = $('#area');
//POPULATE SELECTORS:
PopulateFields();

/*Nombre: PopulateFields
 Tarea: Poblar el selector de Fields con los Fields existentes. Este mismo se encargar치 de llamar a la poblaci칩n de 치reas.*/
function PopulateFields() {
    var current_field;
    $.ajax({
        url: "/Farm_Field",
        data: {},
        success: function (data) {
            var options = "";
            $.each(data, function (index, value) {
                options += '<option value="' + value.field_id + '">' + value.field_name + '</option>';
            });
            field_selector.html(options);
            current_field = $("#field").val();
            //PRUEBA DE CONTROL: console.log(current_field);
            PopulateAreaForField(current_field);
        }
    });
}

/*Nombre: PopulateAreaForField
 Tarea: Poblar el selector de Area de acuerdo a Field que este en el selector de Field
 Parametro: Recibe de la funci칩n PopulateFields el Field actual en el selector de Field*/
function PopulateAreaForField(field){
    $.ajax({
        url: "Area_Search",
        data: {fk_farm_field: field},
        success: function (data){
            var options ="";
            $.each(data, function(index,value){
                options += '<option value=" '+ value.area_id+ '">' + value.area_name + '</option>';
            });
            area_selector.html(options);
        }
    });
}

    function getConfigurations() {
        var area_id = $('#area').val();
        //var url = "http://riego.chi.itesm.mx/Area_Configuration/" + area_id;
        var url = "http://localhost:8000/Area_Configuration/" +area_id;
        $.ajax({
            url: url,
            success: function(json){
                $('#opModeSelect').css('display', 'block');
                $('#opAutomatic').css('display', 'none');
                $('#opManual').css('display', 'none');
                $('#opTimer').css ('display', 'none');

                var area_configuration = json.area_configuration.substr(2);
                var area_operation = json.area_configuration[0];
                switch (area_operation){
                    case "1":
                        $('#operationMode').val(1);
                        $('#opManual').css('display', 'block');
                        if(area_configuration === "0"){
                            $('#rOpManOFF').attr('checked', 'checked');
                        }else{
                            $('#rOpManON').attr('checked', 'checked');
                        }
                        break;
                    case "2":
                        $('#operationMode').val(2);
                        $('#opAutomatic').css('display', 'block');
                        $('#maxHum').val(area_configuration.substr(0,2) + "." +  area_configuration.substr(2,1) );
                        $('#minHum').val(area_configuration.substr(3,2) + "." +  area_configuration.substr(5,1) );
                        break;
                    case "3":
                        $('operationMode').val(3);
                        $('#opTimer').css('display','block');
                        break;
                }

            }
        } );
    }

    function hideOperations() {
        $('#opModeSelect').css('display', 'none');
        $('.operationModes').css('display', 'none');
    }

    function loadOperationMode() {
        $('.operationModes').css('display', 'none');
        switch ($('#operationMode').val()) {
            case "1":
                $('#opManual').css('display', 'block');
                break;
            case "2":
                $('#opAutomatic').css('display', 'block');
                break;
            case "3":
                $('#opTimer').css('display', 'block');
                break;
        }
    }

    function saveOpMan() {
        //var area_id = $('#area').val().substring(1,3);
        var area_id = $('#area').val();
        var field_id = $('#field').val();
        if (Number(field_id)<10) {
            strConfig = '0' + field_id + area_id;
        }
        else {
            strConfig = field_id + area_id;
        }
        console.log ("area id from manual mode: " + area_id );
        var url = "http://riego.chi.itesm.mx/Area_Configuration/" + area_id;
        url = url.replace(/\s/g, '');
        console.log(url);

        //strConfig = "1-";
        console.log($('input[name=rOpMan]:radio:checked').val(0));
        switch ($('input[name=rOpMan]:radio:checked').attr('id')) {
            case 'rOpManON':
                strConfig +='1';
                break;
            case 'rOpManOFF':
                strConfig +='0';
                break;
            default:
                alert("You didn't select an operation");
                return;
                break;
        }

        strConfig += '00000';
        strConfig= strConfig.replace(/\s/g, '');
        console.log("Conf string: " + strConfig);

        $.ajax({
            url: url,
            type: 'PUT',
            data: {area_id:area_id, area_configuration: strConfig },
            success: function(data) {
                $('.result').html(data);
                alert('Configuration was sent');
            }
        });
    }

    function saveOpAut() {
        var area_id = $('#area').val();
        var field_id = $('#field').val();
        console.log(field_id);
        if (Number(field_id)<10) {
            strConfig = '0' + field_id + area_id;
        }
        else {
            strConfig = field_id + area_id;
        }

        var url = "http://riego.chi.itesm.mx/Area_Configuration/" + area_id;
        url = url.replace(/\s/g, '');

        strConfig += '2';
        var maxHum = parseFloat($('#maxHum').val());
        var minHum = parseFloat($('#minHum').val());

        var integerMax = parseInt(Math.floor(maxHum) + (maxHum % 1).toFixed(1).substr(2,1));
        var integerMin = parseInt(Math.floor(minHum) + (minHum % 1).toFixed(1).substr(2,1));

        strConfig += lPad3(integerMax) +'#'+ lPad3(integerMin);
        strConfig = strConfig.replace(/\s/g, '');
        console.log('strConf de auto mode: '+ strConfig);

        $.ajax({
            url: url,
            type: 'PUT',
            data: {area_id:area_id, area_configuration: strConfig },
            success: function(data) {
                $('.result').html(data);
                alert('Configuration was sent');
            }
        });
    }

    function saveOpTim() {
        var area_id = $('#area').val();
        var field_id = $('#field').val();
        console.log(field_id);
        if (Number(field_id)<10) {
            strConfig = '0' + field_id + area_id;
        }
        else {
            strConfig = field_id + area_id;
        }
        var url = "http://riego.chi.itesm.mx/Area_Configuration/" + area_id;
        url = url.replace(/\s/g, '');

        strConfig += '3';
        strConfig += '#' + getBinaryDays();
        var duration = $('#duration_time').val();
        var start = $ ('#start_time').val();
        console.log(start);
        strConfig += '#'+ start + '#' + duration;
        strConfig= strConfig.replace(/\s/g, '');

        $.ajax({
            url: url,
            type: 'PUT',
            data: {area_id:area_id, area_configuration: strConfig },
            success: function(data) {
                $('.result').html(data);
                alert('Configuration was sent');
            }
        });


    }
    function getBinaryDays () {
        var bin_sum= 0;
     var mon = parseInt($('#mon:checked').val());
        mon = mon || 0;
     var tue = parseInt($('#tue:checked').val());
        tue = tue || 0;
     var wed = parseInt($('#wed:checked').val());
        wed = wed || 0;
     var thu = parseInt($('#thu:checked').val());
        thu = thu || 0;
     var fri = parseInt($('#fri:checked').val());
        fri = fri || 0;
     var sat = parseInt($('#sat:checked').val());
        sat = sat || 0;
     var sun = parseInt($('#sun:checked').val());
        sun = sun || 0;
     bin_sum = mon+tue+wed+thu+fri+sat+sun;
        console.log("BIN SUM: " + bin_sum);
        return bin_sum;
    }

    function lPad3(number) {
        if (number<=999) { number = ("00"+number).slice(-3); }
        return number;
    }
</script>
</body>
</html>